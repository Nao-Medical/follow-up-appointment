<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appointment Booking Tool</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
</head>

<body>
  <div class="background">
    <div class="shape shape1"></div>
    <div class="shape shape2"></div>
    <div class="shape shape3"></div>
    <div class="shape shape4"></div>
  </div>

  <header class="app-header">
    <div class="logo">
      <!-- <img
          src="https://naomedical.com/support/assets/logo-main.png"
          alt="Nao Medical Logo"
        /> -->
    </div>
    <div id="userName" class="user-name" style="font-weight: 500; font-size: 20px"></div>
    <button id="logoutButton" class="logout-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      Logout
    </button>
  </header>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1 class="card-title">Appointment Booking Tool</h1>
        <p class="card-subtitle">Book your next appointment</p>
      </div>
      <div class="card-content">
        <form id="bookingForm" autocomplete="off">
          <div class="form-progress">
            <div class="progress-step active" data-step="1">
              <div class="step-number">1</div>
              <div class="step-label">Account</div>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="2">
              <div class="step-number">2</div>
              <div class="step-label">Details</div>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="3">
              <div class="step-number">3</div>
              <div class="step-label">Schedule</div>
            </div>
          </div>

          <!-- Step 1: Account Information -->
          <div class="form-step active" data-step="1">
            <!-- Implement this later _______------ -->
            <!-- <button
                type="button"
                id="registerNewPatientBtn"
                class="btn btn-secondary"
              >
                Register New Patient
              </button> -->
            <!-- Account Number -->
            <div class="form-group">
              <label for="accountNumber">Enter Account or Phone number</label>
              <div class="input-wrapper">
                <div class="input-wrapper">
                  <input id="accountNumber" class="form-control" type="text" placeholder="Enter Account" required />
                  <button type="button" id="searchAccountBtn" class="search-btn" title="Search Account">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Search
                  </button>
                </div>

                <div id="accountInfoBox" class="account-info-box" style="display: none"></div>
                <div id="patientSelection" class="patient-selection" style="display: none; margin-top: 20px">
                  <label for="patientSelect">Select Patient</label>
                  <select id="patientSelect" class="form-control"></select>
                </div>
              </div>
            </div>

            <!-- Location Selection -->
            <div class="form-group">
              <label for="locationSelect">Select Location</label>
              <div class="select-wrapper">
                <select id="locationSelect" class="form-control" required></select>
              </div>
            </div>

            <!-- Appointment Results -->
            <div class="form-group" id="appointmentResults" style="display: none">
              <h3 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Recent Appointments
              </h3>
              <div id="appointmentOutput" class="appointment-cards"></div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-next" id="step1Next">
                Continue
              </button>
            </div>
          </div>

          <!-- Step 2: Visit Details -->
          <div class="form-step" data-step="2">
            <!-- Visit Reason -->
            <div class="form-group">
              <label for="visitReason">Visit Reason</label>
              <div class="input-wrapper">
                <input id="visitReason" class="form-control" type="text" placeholder="Enter reason for the visit"
                  required />
              </div>
            </div>

            <!-- Visit Type -->
            <div class="form-group">
              <label for="visitType">Select Visit Type</label>
              <div class="select-wrapper">
                <select id="visitType" class="form-control" required>
                  <option value="" disabled selected>
                    -- Choose Visit Type --
                  </option>
                  <option value="pcp">Primary Care (PCP)</option>
                  <option value="urgent care">Urgent Care</option>
                  <option value="psych">Mental Health (Psych)</option>
                  <option value="nutri">Nutrition</option>
                  <option value="cdl">CDL Exam</option>
                  <option value="immigration">Immigration</option>
                  <option value="televisit">Televisit</option>
                  <option value="CDL EST">CDL EST</option>
                  <option value="CDL FU">CDL FU</option>
                  <option value="CDL NP">CDL NP</option>
                  <option value="Imm NP">Imm NP</option>
                  <option value="MAWL EST">MAWL EST</option>
                  <option value="Nutri Est">Nutri Est</option>
                  <option value="Nutri NP">Nutri NP</option>
                  <option value="OccMed-Emp">OccMed-Emp</option>
                  <option value="PCP EST">PCP EST</option>
                  <option value="PCP NP">PCP NP</option>
                  <option value="PCP TV Est">PCP TV Est</option>
                  <option value="Psych Est">Psych Est</option>
                  <option value="Psych NP">Psych NP</option>
                  <option value="SP EST">SP EST</option>
                  <option value="SP NEW">SP NEW</option>
                  <option value="Sprav EST">Sprav EST</option>
                  <option value="Sprav NP">Sprav NP</option>
                  <option value="SUBOX EST">SUBOX EST</option>
                  <option value="TV Est">TV Est</option>
                  <option value="TV NP">TV NP</option>
                  <option value="UC EST">UC EST</option>
                  <option value="UC NP">UC NP</option>
                  <option value="WC Est">WC Est</option>
                  <option value="WH NP">WH NP</option>
                </select>
              </div>
            </div>

            <!-- Same Provider -->
            <div class="form-group checkbox-group" id="sameProviderSection">
              <label class="checkbox-label" id="sameProviderLabel">
                <input type="checkbox" id="sameProvider" />
                <span class="checkbox-custom"></span>
                <span class="checkbox-text" id="sameProviderText">Same Provider</span>
              </label>
            </div>

            <!-- Appointment Date -->
            <div class="form-group">
              <label for="appointDate">Select Appointment Date</label>
              <!-- Chips for selecting 3 or 7 days -->
              <div class="chips-container">
                <span id="chip-3days" class="chip" data-days="3">In 3 Days</span>
                <span id="chip-7days" class="chip" data-days="7">In 7 Days</span>
              </div>
              <div class="input-wrapper">
                <input type="date" id="appointDate" class="form-control" required min="" />
                <div class="input-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-back" id="step2Back">
                Back
              </button>
              <button type="button" class="btn btn-next" id="step2Next">
                Continue
              </button>
            </div>
          </div>

          <!-- Step 3: Provider and Time Selection -->
          <div class="form-step" data-step="3">
            <!-- Available Providers -->
            <div class="form-group" id="providerSection" style="display: none">
              <label for="providerSelect">Available Providers</label>
              <div class="select-wrapper">
                <select id="providerSelect" class="form-control"></select>
              </div>
            </div>

            <!-- Available Time Slots -->
            <div class="form-group" id="timeSlotsSection" style="display: none">
              <div class="slot-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <label>Available Time Slots</label>
              </div>
              <div id="timeSlots" class="time-slots"></div>
            </div>

            <!-- No Providers Message -->
            <div id="noProvidersMessage" class="message-box" style="display: none">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <p>
                Oops! Looks like no providers are available for that visit
                type on this date. Try picking a different date—we'll find a
                spot for you!
              </p>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-back" id="step3Back">
                Back
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                Schedule Appointment
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="modal-icon success">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <h2>Appointment Scheduled!</h2>
      <p>Your appointment has been successfully scheduled.</p>
      <button class="btn btn-primary" id="closeSuccessModal">Done</button>
    </div>
  </div>

  <!-- Improved Registration Modal -->
  <div id="registerPatientModal" class="modal">
    <div class="modal-content registration-modal">
      <div class="modal-header">
        <h2>Register New Patient</h2>
        <p class="modal-subtitle">Please fill in the patient details</p>
      </div>
      <form id="registerPatientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="regFirstName">First Name</label>
            <div class="input-wrapper">
              <input type="text" id="regFirstName" class="form-control" placeholder="Enter first name" required />
            </div>
          </div>
          <div class="form-group">
            <label for="regLastName">Last Name</label>
            <div class="input-wrapper">
              <input type="text" id="regLastName" class="form-control" placeholder="Enter last name" required />
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="regDob">Date of Birth</label>
            <div class="input-wrapper">
              <input type="date" id="regDob" class="form-control" required />
              <div class="input-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="regGender">Gender</label>
            <div class="select-wrapper">
              <select id="regGender" class="form-control" required>
                <option value="" disabled selected>Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="regEmail">Email</label>
          <div class="input-wrapper">
            <input type="email" id="regEmail" class="form-control" placeholder="Enter email address" required />
          </div>
        </div>

        <div class="form-group">
          <label for="regPhone">Phone Number</label>
          <div class="input-wrapper">
            <input type="text" id="regPhone" class="form-control" placeholder="Enter phone number" required />
          </div>
        </div>

        <div class="form-section-title">Address Information</div>

        <div class="form-group">
          <label for="regAddress1">Address Line 1</label>
          <div class="input-wrapper">
            <input type="text" id="regAddress1" class="form-control" placeholder="Enter street address" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="regCity">City</label>
            <div class="input-wrapper">
              <input type="text" id="regCity" class="form-control" placeholder="Enter city" />
            </div>
          </div>
          <div class="form-group">
            <label for="regState">State</label>
            <div class="input-wrapper">
              <input type="text" id="regState" class="form-control" placeholder="Enter state" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="regZip">Zip Code</label>
          <div class="input-wrapper">
            <input type="text" id="regZip" class="form-control" placeholder="Enter zip code" />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="closeRegisterModal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Register</button>
        </div>
      </form>
    </div>
  </div>

  <script src="script.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0Ktvcyt1TWH50oBa2nDYfpge7gEJdp_Y",
      authDomain: "follow-up-d588a.firebaseapp.com",
      projectId: "follow-up-d588a",
      storageBucket: "follow-up-d588a.firebasestorage.app",
      messagingSenderId: "103118827522",
      appId: "1:103118827522:web:31ed6cd3b53c54ea2c771b",
      measurementId: "G-MJN9QVL2G7",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();

    // Handle logout button click
    document
      .getElementById("logoutButton")
      .addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "login.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      });

    const redirectIfNotAuthenticated = () => {
      onAuthStateChanged(auth, (user) => {
        if (!user || !user.email.endsWith("@naomedical.com")) {
          window.location.href = "login.html";
        } else {
          console.log(
            "🚀 ~ onAuthStateChanged ~ user.displayName:",
            user.displayName
          );
          localStorage.setItem("userName", user.displayName);
          // Set the user's name in the userName div directly
          document.getElementById(
            "userName"
          ).textContent = `Welcome, ${user.displayName}`;
        }
      });
    };

    window.addEventListener("pageshow", redirectIfNotAuthenticated);

    redirectIfNotAuthenticated();

    document.addEventListener("DOMContentLoaded", () => {
      const registerBtn = document.getElementById("registerNewPatientBtn");
      if (registerBtn) {
        registerBtn.addEventListener("click", () => {
          document
            .getElementById("registerPatientModal")
            .classList.add("active");
          populateLocationDropdown("regLocationSelect");
        });
      }

      const closeBtn = document.getElementById("closeRegisterModal");
      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          document
            .getElementById("registerPatientModal")
            .classList.remove("active");
        });
      }

      document
        .getElementById("registerPatientForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            firstName: document.getElementById("regFirstName").value,
            lastName: document.getElementById("regLastName").value,
            dob: document.getElementById("regDob").value,
            gender: document.getElementById("regGender").value,
            email: document.getElementById("regEmail").value,
            phone: document.getElementById("regPhone").value,
            address: document.getElementById("regAddress1").value,
            city: document.getElementById("regCity").value,
            state: document.getElementById("regState").value,
            zip: document.getElementById("regZip").value,
          };

          try {
            showLoading();
            const response = await fetch(
              `https://nexhealth-custom-server-1081644116068.us-central1.run.app/api/youologist/register-appoint-flow`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );
            const result = await response.json();

            if (response.ok) {
              // Show success message
              const successModal = document.createElement("div");
              successModal.className = "modal active";
              successModal.innerHTML = `
                  <div class="modal-content">
                    <div class="modal-icon success">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                      </svg>
                    </div>
                    <h2>Registration Successful!</h2>
                    <p>The patient has been successfully registered.</p>
                    <button class="btn btn-primary" id="closeRegSuccessModal">Continue</button>
                  </div>
                `;
              document.body.appendChild(successModal);

              document
                .getElementById("closeRegSuccessModal")
                .addEventListener("click", () => {
                  successModal.remove();
                  document
                    .getElementById("registerPatientModal")
                    .classList.remove("active");

                  // Optionally, populate the account number field with the new patient's ID
                  if (result.patientId) {
                    document.getElementById("accountNumber").value =
                      result.patientId;
                  }
                });
            } else {
              alert(
                "Failed to register patient: " +
                (result.message || "Unknown error")
              );
            }
          } catch (err) {
            console.error("Registration error:", err);
            alert("Failed to register patient. Please try again.");
          } finally {
            hideLoading();
          }
        });
    });
  </script>
</body>

</html>